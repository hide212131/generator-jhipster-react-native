import { call, put } from 'redux-saga/effects'
import { callApi } from '../../../shared/sagas/call-api.saga'
import <%= entity.entityNameCapitalized %>Actions from './<%= entity.entityFileName %>.reducer'
<%_ if (entity.fieldsContainDate) { _%>
import {
  <%_ if (fieldsContainZonedDateTime || entity.fieldsContainInstant) { _%>
  convertDateTimeFromServer,
  <%_ } _%>
  <%_ if (fieldsContainLocalDate) { _%>
  convertLocalDateFromServer,
  <%_ } _%>
} from '../../../shared/util/date-transforms'
<%_ } _%>

function * get<%= entity.entityNameCapitalized %> (api, action) {
  const { <%= entity.entityInstance %>Id } = action
  // make the call to the api
  const apiCall = call(api.get<%= entity.entityNameCapitalized %>, <%= entity.entityInstance %>Id)
  const response = yield call(callApi, apiCall)

  // success?
  if (response.ok) {
    <%_ if (entity.fieldsContainDate) { _%>
    response.data = mapDateFields(response.data)
    <%_ } _%>
    yield put(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>Success(response.data))
  } else {
    yield put(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>Failure(response.data))
  }
}

function * getAll<%= entity.entityNamePlural %> (api, action) {
  const { options } = action
  // make the call to the api
  const apiCall = call(api.getAll<%= entity.entityNamePlural %>, options)
  const response = yield call(callApi, apiCall)

  // success?
  if (response.ok) {
    yield put(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>AllSuccess(response.data, response.headers))
  } else {
    yield put(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>AllFailure(response.data))
  }
}

function * update<%= entity.entityNameCapitalized %> (api, action) {
  const { <%= entity.entityInstance %> } = action
  // make the call to the api
  const idIsNotNull = !(<%= entity.entityInstance %>.id === null || <%= entity.entityInstance %>.id === undefined);
  const apiCall = call(idIsNotNull ? api.update<%= entity.entityNameCapitalized %> : api.create<%= entity.entityNameCapitalized %>, <%= entity.entityInstance %>)
  const response = yield call(callApi, apiCall)

  // success?
  if (response.ok) {
    <%_ if (entity.fieldsContainDate) { _%>
    response.data = mapDateFields(response.data)
    <%_ } _%>
    yield put(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>UpdateSuccess(response.data))
  } else {
    yield put(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>UpdateFailure(response.data))
  }
}

<%_ if (entity.searchEngineAny) { _%>
function * search<%= entity.entityNamePlural %> (api, action) {
  const { query } = action
  // make the call to the api
  const apiCall = call(api.search<%= entity.entityNamePlural %>, query)
  const response = yield call(callApi, apiCall)

  // success?
  if (response.ok) {
    yield put(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>SearchSuccess(response.data))
  } else {
    yield put(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>SearchFailure(response.data))
  }
}
<%_ } _%>
function * delete<%= entity.entityNameCapitalized %> (api, action) {
  const { <%= entity.entityInstance %>Id } = action
  // make the call to the api
  const apiCall = call(api.delete<%= entity.entityNameCapitalized %>, <%= entity.entityInstance %>Id)
  const response = yield call(callApi, apiCall)

  // success?
  if (response.ok) {
    yield put(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>DeleteSuccess())
  } else {
    yield put(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>DeleteFailure(response.data))
  }
}
<%_ if (entity.fieldsContainDate) { _%>
function mapDateFields (data) {
<%_ entity.fields.filter(field => !field.id).forEach(function (field) { _%>
<%_ if (field.fieldType === 'LocalDate') { _%>
  data.<%= field.fieldName %> = convertLocalDateFromServer(data.<%= field.fieldName %>)
<%_ } else if (field.fieldType === 'ZonedDateTime' || field.fieldType === 'Instant') { _%>
  data.<%= field.fieldName %> = convertDateTimeFromServer(data.<%= field.fieldName %>)
<%_ } _%>
<%_ }) _%>
  return data
}
<%_ } _%>

export default {
  getAll<%= entity.entityNamePlural %>,
  get<%= entity.entityNameCapitalized %>,
  delete<%= entity.entityNameCapitalized %>,
  <%_ if (entity.searchEngineAny) { _%>
  search<%= entity.entityNamePlural %>,
  <%_ } _%>
  update<%= entity.entityNameCapitalized %>,
};

