import React from 'react'
import { ActivityIndicator, ScrollView, Text, <% if (entity.fieldsContainImageBlob) { %>Image, <% } %>View } from 'react-native';
import { connect } from 'react-redux'
import { useFocusEffect } from '@react-navigation/native';
<%_ if (entity.fieldsContainLocalDate) { _%>
import { convertLocalDateToString } from '../../../shared/util/date-transforms'
<%_ } _%>

import <%= entity.entityNameCapitalized %>Actions from './<%= entity.entityFileName %>.reducer'
import RoundedButton from '../../../shared/components/rounded-button/rounded-button'
import <%= entity.entityNameCapitalized %>DeleteModal from './<%= entity.entityFileName %>-delete-modal';
import styles from './<%= entity.entityFileName %>-styles'

function <%= entity.entityNameCapitalized %>DetailScreen(props) {
  const { route, get<%= entity.entityNameCapitalized %>, navigation, <%= entity.entityInstance %>, fetching, error } = props;
  const [deleteModalVisible, setDeleteModalVisible] = React.useState(false);
  // prevents display of stale reducer data
  const entityId = <%= entity.entityInstance %>?.id ?? null;
  const routeEntityId = route.params?.entityId ?? null;
  const correctEntityLoaded = routeEntityId && entityId && routeEntityId.toString() === entityId.toString();

  useFocusEffect(
    React.useCallback(() => {
      if (!routeEntityId) {
        navigation.navigate('<%= entity.entityNameCapitalized %>');
      } else {
        setDeleteModalVisible(false);
        get<%= entity.entityNameCapitalized %>(routeEntityId);
      }
    }, [routeEntityId, get<%= entity.entityNameCapitalized %>, navigation]),
  );

  if (!entityId && !fetching && error) {
    return (
      <View style={styles.loading}>
        <Text>Something went wrong fetching the <%= entity.entityNameCapitalized %>.</Text>
      </View>
    );
  }
  if (!entityId || fetching || !correctEntityLoaded) {
    return (
      <View style={styles.loading}>
        <ActivityIndicator size="large" />
      </View>
    );
  }
  return (
    <ScrollView style={styles.container} contentContainerStyle={styles.paddedScrollView} testID="<%= entity.entityInstance %>DetailScrollView">
      <Text style={styles.label}>Id:</Text>
      <Text>{<%= entity.entityInstance %>.id}</Text>
      <%_ entity.fields.filter(field => !field.id).forEach(function (field) { _%>
      {/* <%= field.fieldNameCapitalized %> Field */}
      <Text style={styles.label}><%= field.fieldNameCapitalized %>:</Text>
      <%_ if (field.fieldType === 'LocalDate') { _%>
        <Text testID='<%= field.fieldName %>'>{convertLocalDateToString(<%= entity.entityInstance %>.<%= field.fieldName %>)}</Text>
      <%_ } else if (field.fieldType === 'ZonedDateTime' || field.fieldType === 'Instant' || field.fieldType === 'Boolean') { _%>
        <Text testID='<%= field.fieldName %>'>{String(<%= entity.entityInstance %>.<%= field.fieldName %>)}</Text>
      <%_ } else if (field.fieldType === 'byte[]' && field.fieldTypeBlobContent === 'any') { _%>
        <Text testID='<%= field.fieldName %>'>Open {<%= entity.entityInstance %>.<%= field.fieldName %>ContentType} (not implemented)</Text>
      <%_ } else if (field.fieldType === 'byte[]' && field.fieldTypeBlobContent === 'image') { _%>
        <Text testID='<%= field.fieldName %>ContentType'>{<%= entity.entityInstance %>.<%= field.fieldName %>ContentType}</Text>
        <Image
          testID="<%= field.fieldName %>"
          style={styles.imageBlob}
          source={{ uri: `data:${<%= entity.entityInstance %>.<%= field.fieldName %>ContentType};base64,${<%= entity.entityInstance %>.<%= field.fieldName %>}` }}
        />
      <%_ } else { _%>
        <Text testID='<%= field.fieldName %>'>{<%= entity.entityInstance %>.<%= field.fieldName %>}</Text>
      <%_ } _%>
      <%_ }) _%>
      <%_ entity.relationships.filter(relation => relation.ownerSide).forEach(function (relation) { _%>
        <Text style={styles.label}><%= relation.relationshipNameHumanized %>:</Text>
        <%_ if (relation.relationshipType === 'many-to-many') { _%>
        {<%= entity.entityInstance %>.<%= relation.relationshipNamePlural %> && <%= entity.entityInstance %>.<%= relation.relationshipNamePlural %>.map((entity, index) => (
          <Text key={index} testID={`<%= relation.relationshipNamePlural %>-${index}`}>{String(entity.<%= relation.otherEntityField %> || '')}</Text>
        ))}
        <%_ } else { _%>
        <Text testID='<%= relation.relationshipName %>'>{String(<%= entity.entityInstance %>.<%= relation.relationshipName %> ? <%= entity.entityInstance %>.<%= relation.relationshipName %>.<%= relation.otherEntityField %> : '')}</Text>
        <%_ } _%>
      <%_ }) _%>

      <View style={styles.entityButtons}>
        <RoundedButton
          text="Edit"
          onPress={() => navigation.navigate('<%= entity.entityNameCapitalized %>Edit', { entityId })}
          accessibilityLabel={'<%= entity.entityNameCapitalized %> Edit Button'}
          testID="<%= entity.entityInstance %>EditButton"
        />
        <RoundedButton
          text="Delete"
          onPress={() => setDeleteModalVisible(true)}
          accessibilityLabel={'<%= entity.entityNameCapitalized %> Delete Button'}
          testID="<%= entity.entityInstance %>DeleteButton"
        />
        {deleteModalVisible && (
          <<%= entity.entityNameCapitalized %>DeleteModal
            navigation={navigation}
            visible={deleteModalVisible}
            setVisible={setDeleteModalVisible}
            entity={<%= entity.entityInstance %>}
            testID="<%= entity.entityInstance %>DeleteModal"
          />
        )}
      </View>
    </ScrollView>
  );
}

const mapStateToProps = (state) => {
  return {
    <%= entity.entityInstance %>: state.<%= entity.entityInstancePlural %>.<%= entity.entityInstance %>,
    error: state.<%= entity.entityInstancePlural %>.errorOne,
    fetching: state.<%= entity.entityInstancePlural %>.fetchingOne,
    deleting: state.<%= entity.entityInstancePlural %>.deleting,
    errorDeleting: state.<%= entity.entityInstancePlural %>.errorDeleting
  }
}

const mapDispatchToProps = (dispatch) => {
  return {
    get<%= entity.entityNameCapitalized %>: (id) => dispatch(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>Request(id)),
    getAll<%= entity.entityNamePlural %>: (options) => dispatch(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>AllRequest(options)),
    delete<%= entity.entityNameCapitalized %>: (id) => dispatch(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>DeleteRequest(id)),
    reset<%= entity.entityNamePlural %>: () => dispatch(<%= entity.entityNameCapitalized %>Actions.<%= entity.entityInstance %>Reset()),
  }
}

export default connect(mapStateToProps, mapDispatchToProps)(<%= entity.entityNameCapitalized %>DetailScreen)
